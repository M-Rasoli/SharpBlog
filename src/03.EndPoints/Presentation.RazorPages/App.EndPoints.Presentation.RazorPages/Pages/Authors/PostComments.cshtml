@page "{id:int}"

@using App.Domain.Core.CommentAgg.Enums
@using App.EndPoints.Presentation.RazorPages.Tools
@using MaktabGram.Framework
@model App.EndPoints.Presentation.RazorPages.Pages.Authors.PostCommentsModel
@{
    ViewData["Title"] = "مدیریت نظرات پست";
    Layout = "Shared/_Layout";
}

<main class="flex-1 overflow-x-hidden overflow-y-auto md:mr-64 p-6 transition-all duration-300">
    <section class="mb-8">
        <!-- هدر گرادینتی خفن -->
        <div class="bg-gradient-to-r from-purple-600 via-pink-600 to-amber-500 rounded-2xl p-8 text-white shadow-2xl mb-10 text-center md:text-right">
            <h1 class="text-4xl font-bold flex items-center justify-center md:justify-start gap-4">
                <i data-lucide="message-square-text" class="w-12 h-12"></i>
                مدیریت نظرات
            </h1>
            <p class="mt-3 text-xl font-semibold">پست: @Model.PostTitle</p>
            <p class="text-lg opacity-95">تعداد نظرات: <strong>@Model.Comments.Count()</strong></p>
        </div>

        @if (!Model.Comments.Any())
        {
            <div class="text-center py-20 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-300">
                <i data-lucide="heart-handshake" class="w-24 h-24 text-gray-300 mx-auto mb-6"></i>
                <p class="text-2xl font-bold text-gray-600">هنوز هیچ نظری ثبت نشده</p>
                <p class="text-gray-500 mt-2">به محض ثبت اولین نظر، اینجا نمایش داده میشه</p>
            </div>
        }
        else
        {
            <div class="space-y-6">
                @foreach (var comment in Model.Comments)
                {
                    <div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-gray-100 overflow-hidden">
                        <div class="p-6">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                                <!-- اطلاعات کاربر -->
                                <div class="flex items-start gap-4 flex-1">
                                    <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg flex-shrink-0">
                                        @(string.IsNullOrEmpty(comment.FirstName) ? "?" : comment.FirstName[0].ToString().ToUpper())
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-lg text-gray-800">
                                            @comment.FirstName @comment.LastName
                                        </h3>
                                        <p class="text-sm text-gray-500">
                                            <i data-lucide="mail" class="w-4 h-4 inline"></i> @comment.Email
                                        </p>
                                        <p class="text-sm text-gray-500 mt-1">
                                            <i data-lucide="calendar" class="w-4 h-4 inline"></i>
                                            @comment.CreatedAt.ToPersianString()
                                        </p>
                                    </div>
                                </div>

                                <!-- امتیاز + وضعیت -->
                                <div class="flex flex-col items-end gap-3">
                                    <div class="flex items-center gap-1">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= comment.Rate)
                                            {
                                                <i data-lucide="star" class="w-6 h-6 text-amber-400 fill-amber-400"></i>
                                            }
                                            else
                                            {
                                                <i data-lucide="star" class="w-6 h-6 text-gray-300"></i>
                                            }
                                        }
                                        <span class="mr-2 text-sm font-bold text-gray-700">@comment.Rate از ۵</span>
                                    </div>

                                    <!-- وضعیت فعلی -->
                                    <span class="px-4 py-2 rounded-full text-xs font-bold
                                        @(comment.Status == CommentStatusEnum.Confirmed ? "bg-green-100 text-green-800" : 
                                          comment.Status == CommentStatusEnum.Pending ? "bg-yellow-100 text-yellow-800" : 
                                          "bg-red-100 text-red-800")">
                                        @comment.Status.GetEnumName()
                                    </span>
                                </div>
                            </div>

                            <!-- متن نظر -->
                            <div class="mt-5 p-5 bg-gray-50 rounded-xl border border-gray-200">
                                <p class="text-gray-700 leading-relaxed text-justify">
                                    @comment.CommentText
                                </p>
                            </div>

                            <!-- دکمه‌های تغییر وضعیت -->
                            <div class="mt-5 flex justify-end gap-3 flex-wrap">
                                <form method="post" asp-page-handler="ChangeStatus" asp-route-cmId="@comment.Id">
                                    @* این hidden خیلی مهمه — همیشه id رو می‌فرسته *@
        
                                    <button type="submit"
                                            name="Status"
                                            value="@CommentStatusEnum.Confirmed"
                                            class="px-5 py-2 rounded-lg transition shadow-md text-sm font-medium
                       @(comment.Status == CommentStatusEnum.Confirmed 
                           ? "bg-green-600 text-white ring-4 ring-green-300" 
                           : "bg-gray-200 text-gray-700 hover:bg-green-500 hover:text-white")">
                                        تایید کردن
                                    </button>

                                    <button type="submit"
                                            name="Status"
                                            value="@CommentStatusEnum.Pending"
                                            class="px-5 py-2 rounded-lg transition shadow-md text-sm font-medium
                       @(comment.Status == CommentStatusEnum.Pending 
                           ? "bg-yellow-600 text-white ring-4 ring-yellow-300" 
                           : "bg-gray-200 text-gray-700 hover:bg-yellow-500 hover:text-white")">
                                        در انتظار
                                    </button>

                                    <button type="submit"
                                            name="Status"
                                            value="@CommentStatusEnum.Denied"
                                            class="px-5 py-2 rounded-lg transition shadow-md text-sm font-medium
                       @(comment.Status == CommentStatusEnum.Denied 
                           ? "bg-red-600 text-white ring-4 ring-red-300" 
                           : "bg-gray-200 text-gray-700 hover:bg-red-500 hover:text-white")">
                                        رد کردن
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- خط گرادینت پایین -->
                        <div class="h-1 bg-gradient-to-r from-purple-500 via-pink-500 to-amber-400"></div>
                    </div>
                }
            </div>
        }

        <!-- دکمه بازگشت -->
        <div class="mt-10 text-center">
            <a href="javascript:history.back()" 
               class="inline-flex items-center gap-2 px-8 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                بازگشت به لیست پست‌ها
            </a>
        </div>
    </section>
</main>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
        });
    </script>
}